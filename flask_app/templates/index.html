{% extends "base.html" %}
{% from "macros.html" import glossary_content, methodology_content %}

{% block title %}Naismith Nerds{% endblock %}
{% block body_class %}page-index{% endblock %}

{% block content %}
<h1>üèÄ Welcome, Naismith Nerds üèÄ</h1>

<!-- Credits -->
<div class="credits">
    <p>Created by Jason Gardner, January 2025</p>
    <p>Stats from thrice-weekly semi-formal pickup basketball in SE Washington, DC beginning January 2025</p>
    <p>Additional credit to Jack Stubblefield for sous-stat-taking, data validation, and further ideas</p>
    <p><a href="http://www.pierrewhatley.com">Support Collective Hooper Pierre Whatley for Congress!</a></p>
</div>

<!-- Social media icons -->
<div class="social-icons">
    <a href="https://www.linkedin.com/in/jasonmgardner99" target="_blank"><i class="fab fa-linkedin"></i></a>
    <a href="https://github.com/jmgjasongardner/naismith-nerds" target="_blank"><i class="fab fa-github"></i></a>
    <a href="https://www.instagram.com/jmgjasongardner" target="_blank"><i class="fab fa-instagram"></i></a>
    <a href="https://twitter.com/jmgjasongardner" target="_blank"><i class="fab fa-twitter"></i></a>
    <a href="https://bsky.app/profile/jmgard.bsky.social" target="_blank"><i class="fab fa-bluesky"></i></a>
</div>

<!-- Top layout: images + birthdays -->
<div class="home-layout">
    <div class="left-col">
        <img class="naismith-img"
             src="{{ url_for('static', filename='naismith.jpeg') }}"
             alt="Naismith Nerds">
    </div>

    <div class="middle-col">
        <img class="color-img"
             src="{{ url_for('static', filename='nbamath.jpg') }}"
             alt="NBA Math">
    </div>

    <div class="right-col">
        <div id="birthdayScroll" class="birthday-scroll"></div>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="tabs">
    <div class="tab active" data-target="stats">Stats</div>
    <div class="tab" data-target="ratings">Ratings</div>
    <div class="tab" data-target="team_builder">Team Builder</div>
    <div class="tab" data-target="games">Games</div>
    <div class="tab" data-target="player_days">Player Days</div>
    <div class="tab" data-target="player_pairings">Player Pairings</div>
    <div class="tab" data-target="days">Days</div>
</div>
<div class="tabs">
    <div class="tab" data-target="glossary">Glossary and Explanation</div>
    <div class="tab" data-target="methodology">Methodology</div>
</div>

<!-- Min games filter (shared logic in tables.js) -->
<input id="minGamesPlayed" type="number" placeholder="Filter Min Games" oninput="filterByMinGamesPlayed()">

<!-- Stats tab -->
<div class="tab-content stats active">
    <h2>Stats</h2>
    <h3>From {{ num_days }} Runs Since January 11, 2025</h3>
    {% if stats %}
    <table id="statsTable" data-page-table="index-stats">
        <thead>
        <tr>
            {% for col in stats[0].keys() %}
                {% if col != 'has_img' %}
                    <th title="{{ main_tooltip.get(col, '') }}">{{ col }}</th>
                {% endif %}
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in stats %}
            <tr>
                {% for key, value in row.items() %}
                    {% if key != 'has_img' %}
                        <td class="{% if key in ['Player', 'Most Recent Game'] %}no-wrap{% endif %}">
                            {% if key == "Player" %}
                                <a href="{{ url_for('player_page', player_name=row['Player']) }}">
                                    {% if row.has_img %}
                                        <img
                                            loading="lazy"
                                            src="{{ url_for('static', filename='player_pics_thumbs/' ~ row['Player'] ~ '.webp') }}"
                                            alt="{{ row['Player'] }}"
                                            style="width:30px; height:30px; vertical-align:middle; margin-right:5px; border-radius:50%;">
                                    {% endif %}
                                    {{ row['Player'] }}
                                </a>
                            {% elif key == "Most Recent Game" %}
                                <a href="{{ url_for('date_page', date=value) }}">
                                    {{ value }}
                                </a>
                            {% else %}
                                {{ value }}
                            {% endif %}
                        </td>
                    {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No stats available.</p>
    {% endif %}
</div>

<!-- Ratings tab -->
<div class="tab-content ratings">
    <h2>Player Ratings</h2>
    <h3>Best Lambda: {{ best_lambda }}</h3>
    {% if ratings %}
    <table id="ratingsTable" class="small-table">
        <thead>
        <tr>
            {% for col in ratings[0].keys() %}
                {% if col != 'has_img' %}
                    <th title="{{ main_tooltip.get(col, '') }}">{{ col }}</th>
                {% endif %}
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in ratings %}
            <tr>
                {% for key, value in row.items() %}
                    {% if key != 'has_img' %}
                        {% if key == "Player" %}
                            <td>
                                <a href="{{ url_for('player_page', player_name=row['Player']) }}">
                                    {% if row.has_img %}
                                        <img
                                            loading="lazy"
                                            src="{{ url_for('static', filename='player_pics_thumbs/' ~ row['Player'] ~ '.webp') }}"
                                            alt="{{ row['Player'] }}"
                                            style="width:30px; height:30px; vertical-align:middle; margin-right:5px; border-radius:50%;">
                                    {% endif %}
                                    {{ row['Player'] }}
                                </a>
                            </td>
                        {% else %}
                            <td>{{ value }}</td>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No player ratings available.</p>
    {% endif %}

    <div class="plot-container">
        {{ plot_ratings | safe }}
    </div>

    <p>
        Outscoring expectation is how to improve rating<br>
        The more games played, the more the model moves RAPM to match APM (y=x)<br>
        Smaller sample players are regressed more toward zero (y=0) when regularized
    </p>

    <div class="plot-container">
        {{ plot_rapm_apm | safe }}
    </div>
</div>

<!-- Team Builder tab -->
<div class="tab-content team_builder">
    <h2>Team Builder</h2>
    <h3>Select any combo of 2, 4, 6, 8, or 10 players and either assign them to specific teams, or generate teams based on rating.</h3>

    <!-- Controls -->
    <div class="team-builder-controls">
        <input
            type="text"
            id="playerSearch"
            placeholder="Search player name..."
        >
        <button id="generateBtn" class="btn">Generate Teams</button>
        <button id="resetBtn" class="btn">Reset Teams</button>
        <button id="returnBtn" class="btn" style="display:none;">Return to Team Selection</button>
        <div id="comboCount" class="combo-count"></div>
    </div>

    <!-- Summary -->
    <div id="numplayers">
        <strong>Number of Players:</strong> <span id="numPlayersOnCourt">0</span>
    </div>
    <div id="teambuilderratings">
        <strong>Team 1 Rating:</strong> <span id="team1Total">0</span> |
        <strong>Team 2 Rating:</strong> <span id="team2Total">0</span> |
        <strong>Unassigned ON Rating:</strong> <span id="onTotal">0</span>
    </div>
    <div id="spread">
        <strong>Point Spread (T1 ‚àí T2):</strong> <span id="spreadTotal">0</span>
    </div>

    <!-- Selection view -->
    <div id="selectionView">
        {% if ratings %}
        <table id="teamBuilderTable" class="small-table">
            <thead>
            <tr>
                <th>Player</th>
                <th>Rating</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody>
            {% for row in ratings %}
                <tr data-player="{{ row['Player']|e }}" data-rating="{{ row['Rating'] }}">
                    <td class="player-name">{{ row["Player"] }}</td>
                    <td class="rating">{{ row["Rating"] }}</td>
                    <td>
                        <select class="status-select">
                            <option value="OFF">OFF</option>
                            <option value="ON">ON</option>
                            <option value="Team 1">Team 1</option>
                            <option value="Team 2">Team 2</option>
                        </select>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>No player ratings available.</p>
        {% endif %}
    </div>

    <!-- Combinations view -->
    <div id="combosView" style="display:none;">
        <div class="combos-header">
            <strong>Generated team combinations</strong>
        </div>
        <div class="combos-container">
            <table id="combosTable" class="wide-table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Team 1 Players</th>
                    <th>Team 1 Rating</th>
                    <th>Team 2 Players</th>
                    <th>Team 2 Rating</th>
                    <th>Spread (T1 ‚àí T2)</th>
                    <th>|Spread|</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Games tab -->
<div class="tab-content games">
    <h2>Games</h2>
    {% if games %}
    <table id="gamesTable" data-page-table="index-games">
        <thead>
        <tr>
            {% for col in games[0].keys() %}
                <th title="{{ main_tooltip.get(col, '') }}">{{ col }}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in games %}
            <tr>
                {% for key, value in row.items() %}
                    <td>
                        {% if key in ['A1', 'A2', 'A3', 'A4', 'A5', 'B1', 'B2', 'B3', 'B4', 'B5'] %}
                            <a href="{{ url_for('player_page', player_name=value) }}">{{ value }}</a>
                        {% elif key == "Game Date" %}
                            <a href="{{ url_for('date_page', date=value) }}">{{ value }}</a>
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No game data available.</p>
    {% endif %}
</div>

<!-- Player Days tab -->
<div class="tab-content player_days">
    <h2>Player Days</h2>
    {% if player_days %}
    <table id="playerDaysTable">
        <thead>
        <tr>
            {% for col in player_days[0].keys() %}
                <th title="{{ main_tooltip.get(col, '') }}">{{ col }}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in player_days %}
            <tr>
                {% for key, value in row.items() %}
                    {% if key == "Player" %}
                        <td>
                            <a href="{{ url_for('player_page', player_name=value) }}">
                                {{ value }}
                            </a>
                        </td>
                    {% elif key == "Game Date" %}
                        <td>
                            <a href="{{ url_for('date_page', date=value) }}">
                                {{ value }}
                            </a>
                        </td>
                    {% else %}
                        <td>{{ value }}</td>
                    {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No player day data available.</p>
    {% endif %}
</div>

<!-- Player Pairings tab -->
<div class="tab-content player_pairings">
    <h2>Player Pairings</h2>

    <h3>Teammate Combos</h3>
    {% if teammates %}
    <table id="teammatesTable">
        <thead>
        <tr>
            {% for col in teammates[0].keys() %}
                <th title="{{ main_tooltip.get(col, '') }}">{{ col }}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in teammates %}
            <tr>
                {% for key, value in row.items() %}
                    <td class="{% if key in ['Pairing', 'Most Recent Game'] %}no-wrap{% endif %}">
                        {% if key == "Pairing" %}
                            {% set p1, p2 = value.split(" - ") %}
                            <a href="{{ url_for('player_page', player_name=p1) }}">{{ p1 }}</a>
                            &nbsp;‚Äì&nbsp;
                            <a href="{{ url_for('player_page', player_name=p2) }}">{{ p2 }}</a>
                        {% elif key == "Most Recent Game" %}
                            <a href="{{ url_for('date_page', date=value) }}">{{ value }}</a>
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No teammate data available.</p>
    {% endif %}

    <h3>Opponent Combos</h3>
    {% if opponents %}
    <table id="opponentsTable">
        <thead>
        <tr>
            {% for col in opponents[0].keys() %}
                <th title="{{ main_tooltip.get(col, '') }}">{{ col }}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in opponents %}
            <tr>
                {% for key, value in row.items() %}
                    <td class="{% if key == 'Most Recent Game' %}no-wrap{% endif %}">
                        {% if key in ["Player", "Opp"] %}
                            <a href="{{ url_for('player_page', player_name=value) }}">
                                {{ value }}
                            </a>
                        {% elif key == "Most Recent Game" %}
                            <a href="{{ url_for('date_page', date=value) }}">{{ value }}</a>
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No opponent data available.</p>
    {% endif %}
</div>

<!-- Days tab -->
<div class="tab-content days">
    <h2>Days</h2>

    {% if days_of_week %}
    <table id="daysOfWeekTable">
        <thead>
        <tr>
            {% for col in days_of_week[0].keys() %}
                <th title="{{ main_tooltip.get(col, '') }}">{{ col }}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in days_of_week %}
            <tr>
                {% for key, value in row.items() %}
                    <td>{{ value }}</td>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No days of week data available.</p>
    {% endif %}

    {% if days %}
    <table id="daysTable">
        <thead>
        <tr>
            {% for col in days[0].keys() %}
                <th title="{{ main_tooltip.get(col, '') }}">{{ col }}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in days %}
            <tr>
                {% for key, value in row.items() %}
                    {% if key == "Game Date" %}
                        <td>
                            <a href="{{ url_for('date_page', date=value) }}">{{ value }}</a>
                        </td>
                    {% else %}
                        <td>{{ value }}</td>
                    {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No days data available.</p>
    {% endif %}
</div>

<!-- Glossary tab -->
<div class="tab-content glossary">
    {{- glossary_content() -}}
</div>

<!-- Methodology tab -->
<div class="tab-content methodology">
    {{- methodology_content() -}}
</div>
{% endblock %}
